{% extends "_basic.html" %}

{% block header %}
    <style>
        #edituser-form {
            overflow-x: hidden;
        }
    </style>

    <script>
        var socket;
        $(() => {
            socket = io.connect(window.location.host);
        });

        function updatetag(num) {
            console.log("update tag");
            $("#modal-tag").modal("show");
            socket.on('card_connected', (msg) => {
                console.log(`connected: ${msg}`);
                if (num == 1)
                    $("input[name='tag']").val(msg["tag"]);
                else
                    $("input[name='tag2']").val(msg["tag"]);
                updatetag_abort();
            });
        }

        function updatetag_abort() {
            $("#modal-tag").modal("hide");
            socket.off('card_connected');
        }
    </script>
    <script>
        function validate_email(email) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', "/api/check_email", false);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                "email": email
            }));
            if (xhr.status != 200) {
                return false;
            }
            return JSON.parse(xhr.responseText);
        }

        /* beautify ignore:start */
        {% if not flask_login.current_user.is_authenticated %}
        /* beautify ignore:end */
        $(() => {
            $("#edituser-form").submit((event) => {
                var res = validate_email($("#form-item-email").val());
                if (res == false) return;
                if (!res.valid) {
                    $("#form-item-email").addClass("is-invalid");
                    event.preventDefault();
                    event.stopPropagation();
                }
            });
        });
        /* beautify ignore:start */
        {% endif %}
        /* beautify ignore:end */

        function fill_from_mail() {
            var res = validate_email($("#form-item-email").val());
            if (res == false) return;
            if (!res.valid) {
                $("#form-item-email").addClass("is-invalid");
                return;
            }
            $("#form-item-email").removeClass("is-invalid");
            $("#form-item-email").addClass("is-valid");
            $("#form-item-firstname").val(res.firstname)
            $("#form-item-lastname").val(res.lastname)
        }

        function submit_edituser() {
            $('#edituser-form').submit();
        }
    </script>
{% endblock header %}

{% block title %}
    <div class="flex flex-row">
        <h1 class="mb-0">{{ "Edit User" if user.id else "Add User" }}</h1>
        <div class="mx-1 d-flex flex-row column-gap-3 align-items-baseline">
            <div class="color-highlight fs-4">Database ID:</div>
            <div class="main-title-id color-highlight fs-4">
                <strong>{{ user.id }}</strong>
            </div>
        </div>
    </div>
{% endblock title %}

{% block main_nav_items %}
    {{ nav_item('save', 'fas fa-save', type="button", onclick="submit_edituser()") }}
    {{ super() }}
{% endblock main_nav_items %}

{% block main_content %}
    <form id="edituser-form" method="post">
        <input name="id" type="hidden" value="{{ user.id }}" />
        <div class="form-group row">
            <div class="col">
                <label>Tag ID</label>
                <input class="form-control form-control-lg"
                       type="text"
                       name="tag"
                       placeholder="Enter tag id"
                       required
                       value="{{ hexstr(user.tag) }}">
                <small class="form-text text-muted">Enter UID as HEX-String, e.g. <code>01020304</code> or
                    <code>01 02 03 04</code></small>
                <input type="button"
                       class="btn btn-secondary"
                       onclick="updatetag(1)"
                       value="Update Tag">
            </input>
        </div>
        <div class="col">
            <label>Tag2 ID</label>
            <input class="form-control form-control-lg"
                   type="text"
                   name="tag2"
                   placeholder="Enter tag id"
                   value="{{ hexstr(user.tag2) }}">
            <small class="form-text text-muted">Enter UID as HEX-String, e.g. <code>01020304</code> or
                <code>01 02 03 04</code></small>
            <input type="button"
                   class="btn btn-secondary"
                   onclick="updatetag(2)"
                   value="Update Tag">
        </input>
    </div>
</div>
<div class="form-group row">
    <label>E-Mail</label>
    <div class="col mt-0">
        <div class="input-group has-validation">
            <input class="form-control form-control-lg"
                   id="form-item-email"
                   type="email"
                   name="email"
                   placeholder="Enter E-Mail address"
                   required
                   value="{{ user.email or '' }}"
                   autocomplete="off"
                   onclick="simple_keyboard_process(this)">
        </div>
        <div class="invalid-tooltip">E-Mail address could not be found.</div>
    </div>
    <div class="col-auto">
        <input type="button"
               class="btn"
               onclick="fill_from_mail()"
               value="Fill from email" />
    </div>
</div>
<div class="form-group row">
    <div class="col">
        <label>First name</label>
        <input id="form-item-firstname"
               class="form-control"
               type="text"
               name="first_name"
               placeholder="Enter first name"
               required
               value="{{ user.prename }}"
               autocomplete="off"
               onclick="simple_keyboard_process(this)">
    </div>
    <div class="col">
        <label>Last name</label>
        <input id="form-item-lastname"
               class="form-control"
               type="text"
               name="last_name"
               placeholder="Enter last name"
               required
               value="{{ user.name }}"
               autocomplete="off"
               onclick="simple_keyboard_process(this)">
    </div>
</div>
<div class="row my-3 py-3 {{ 'd-none' if not flask_login.current_user.is_authenticated }}"
     style="border: 1px solid var(--color-berry);
            border-radius: 10px">
    <div class="col">
        <h3 class="color-berry">Admin settings</h3>
        <div class="my-3">
            <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       name="enabled"
                       {{ 'checked' if user.enabled }}>
                <label class="form-check-label">Account Enabled</label>
            </div>
        </div>
        <div class="my-3">
            <label>Balance</label>
            <div class="input-group w-50">
                <input class="form-control"
                       type="number"
                       id="form-item-unpayed"
                       name="unpayed"
                       step="0.01"
                       pattern="[+-][0-9]+\.[0-9]+ €"
                       placeholder="0.00 €"
                       autocomplete="off"
                       value="{{ '%0.02f' | format(user.balance) }}" />
                <div class="input-group-append">
                    <div class="input-group-text">EUR</div>
                </div>
            </div>
        </div>
    </div>
</div>
</form>
{% endblock main_content %}

{% block post_body %}
    <!-- Modal update tag -->
    <div class="modal fade"
         id="modal-tag"
         tabindex="-1"
         role="dialog"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content p-3">
                <h2 class="color-berry">Tap new tag.</h2>
                <div class="d-flex flex-column justify-content-center text-center h-100">
                    <div class="display-1 color-berry fas fa-address-card mb-3"></div>
                </div>
                <div class="container">
                    <button class="float-right btn btn-primary" onclick="updatetag_abort()">Abort</button>
                </div>
            </div>
        </div>
    </div>

    {{ simple_keyboard() }}
{% endblock post_body %}
